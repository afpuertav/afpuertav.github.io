<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ESP32 IoT Dashboard</title>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial;
  background: #0f172a;
  color: #e5e7eb;
  text-align: center;
}
canvas {
  max-width: 800px;
  margin: 20px auto;
}
button {
  padding: 14px 28px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: #22c55e;
  color: black;
}
button.off {
  background: #ef4444;
  color: white;
}
</style>
</head>

<body>

<h1>üå°Ô∏è ESP32 ‚Äì Temperatura y Humedad (24h)</h1>

<canvas id="chart"></canvas>

<button id="ledBtn">CONECTANDO‚Ä¶</button>

<script>
/* MQTT CONFIG */
const MQTT_URL = "wss://d0c74dd51f244a5b87e0373b99197ba7.s1.eu.hivemq.cloud:8884/mqtt";
const MQTT_OPTIONS = {
  username: "andresPuerta",
  password: "aGROW123",
  clientId: "web_" + Math.random().toString(16).substr(2, 8)
};

const TOPIC_DATA   = "iot/esp32/data";
const TOPIC_CMD    = "iot/esp32/cmd";
const TOPIC_STATUS = "iot/esp32/status";

/* DATA */
let dataPoints = [];
let ledState = false;

/* CHART */
const ctx = document.getElementById("chart").getContext("2d");
const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label: "Temperatura (¬∞C)", borderColor: "#f97316", data: [] },
      { label: "Humedad (%)", borderColor: "#38bdf8", data: [] }
    ]
  }
});

/* MQTT */
const client = mqtt.connect(MQTT_URL, MQTT_OPTIONS);

client.on("connect", () => {
  client.subscribe(TOPIC_DATA);
  client.subscribe(TOPIC_STATUS);
});

client.on("message", (topic, message) => {

  if (topic === TOPIC_STATUS) {
    ledState = (message.toString() === "ON");
    updateButton();
  }

  if (topic === TOPIC_DATA) {
    const d = JSON.parse(message.toString());
    const now = new Date();

    dataPoints.push({ time: now, temp: d.temp, hum: d.hum });

    const limit = new Date(Date.now() - 24*60*60*1000);
    dataPoints = dataPoints.filter(p => p.time > limit);

    chart.data.labels = dataPoints.map(p => p.time.toLocaleTimeString());
    chart.data.datasets[0].data = dataPoints.map(p => p.temp);
    chart.data.datasets[1].data = dataPoints.map(p => p.hum);
    chart.update();
  }
});

/* BUTTON */
const btn = document.getElementById("ledBtn");

function updateButton() {
  if (ledState) {
    btn.textContent = "APAGAR BOMBA";
    btn.classList.add("off");
  } else {
    btn.textContent = "ENCENDER BOMBA";
    btn.classList.remove("off");
  }
}

btn.onclick = () => {
  client.publish(TOPIC_CMD, ledState ? "LED_OFF" : "LED_ON");
};
</script>

</body>
</html>
