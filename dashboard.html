<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tanque IoT</title>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    
    <style>
        /* ESTILOS (Mismos de antes + ajustes) */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        header { background-color: #1553AD; padding: 1rem; color: white; text-align: center; font-size: 1.5rem; font-weight: bold; }
        .container { max-width: 1000px; margin: 2rem auto; padding: 0 20px; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid #1553AD; }
        .btn-control { padding: 15px; width: 100%; background: #1553AD; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        .btn-control.off { background-color: #e74c3c; }
        .chart-container { position: relative; height: 300px; margin-top: 10px; }
        .metrics-row { display: flex; justify-content: space-around; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .metric { text-align: center; }
        .metric span { font-size: 1.2rem; font-weight: bold; color: #1553AD; }
        .footer-controls { margin-top: 20px; display: flex; gap: 10px; }
        button { cursor: pointer; }
    </style>
</head>
<body>
    <header>üì° Monitor de Tanque IoT</header>
    
    <div class="container">
        
        <div class="card">
            <h3>üéõÔ∏è Control Manual</h3>
            <button id="btnPump" class="btn-control">CONECTANDO...</button>
            <p style="text-align: center; font-size: 0.9rem; margin-top: 10px;">
                Estado: <span id="statusText">Desconectado</span>
            </p>
        </div>
        
        <div class="card">
            <div class="metrics-row">
                <div class="metric">üå°Ô∏è Temp: <span id="currTemp">--</span>¬∞C</div>
                <div class="metric">üíß Hum: <span id="currHum">--</span>%</div>
            </div>
            <div class="chart-container">
                <canvas id="chartClimate"></canvas>
            </div>
        </div>

        <div class="card" style="border-top-color: #27ae60;">
            <div class="metrics-row">
                <div class="metric">üõ¢Ô∏è Nivel Actual: <span id="currVol">--</span> Litros</div>
            </div>
            <div class="chart-container">
                <canvas id="chartTank"></canvas>
            </div>
            
            <div class="footer-controls">
                <button onclick="downloadCSV()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px;">üì• Descargar Excel</button>
                <button onclick="clearESP32Data()" style="padding: 10px 20px; background: transparent; border: 1px solid #ccc; border-radius: 5px;">üóëÔ∏è Borrar Datos</button>
            </div>
        </div>

    </div>

    <script>
        const MQTT_URL = "wss://d0c74dd51f244a5b87e0373b99197ba7.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_OPT = { username: "andresPuerta", password: "aGROW123", reconnectPeriod: 2000 };
        const TOPICS = { DATA: "iot/esp32/data", CMD: "iot/esp32/cmd", STATUS: "iot/esp32/status", HISTORY: "iot/esp32/history" };

        let client;
        let pumpState = null;
        let allHistoryData = [];

        // UI References
        const btnPump = document.getElementById("btnPump");
        const statusText = document.getElementById("statusText");
        const currTemp = document.getElementById("currTemp");
        const currHum = document.getElementById("currHum");
        const currVol = document.getElementById("currVol");

        // --- GRAFICA 1: CLIMA ---
        const ctxClimate = document.getElementById("chartClimate").getContext("2d");
        const chartClimate = new Chart(ctxClimate, {
            type: "line",
            data: {
                datasets: [
                    { label: "Temp (¬∞C)", data: [], borderColor: "#e74c3c", yAxisID: 'y', tension: 0.3, pointRadius: 0 },
                    { label: "Hum (%)", data: [], borderColor: "#3498db", yAxisID: 'y1', tension: 0.3, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } },
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperatura' }, min: 0, max: 50 },
                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Humedad' }, min: 0, max: 100 }
                }
            }
        });

        // --- GRAFICA 2: TANQUE ---
        const ctxTank = document.getElementById("chartTank").getContext("2d");
        const chartTank = new Chart(ctxTank, {
            type: "line",
            data: {
                datasets: [
                    { 
                        label: "Volumen (Litros)", 
                        data: [], 
                        borderColor: "#27ae60", 
                        backgroundColor: "rgba(39, 174, 96, 0.2)", 
                        fill: true, 
                        tension: 0.4 
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } } },
                    y: { beginAtZero: true, title: { display: true, text: 'Litros' } }
                }
            }
        });

        // L√ìGICA MQTT
        function connectMQTT() {
            client = mqtt.connect(MQTT_URL, MQTT_OPT);

            client.on("connect", () => {
                statusText.innerText = "Conectado";
                btnPump.disabled = false;
                client.subscribe([TOPICS.DATA, TOPICS.STATUS, TOPICS.HISTORY]);
                client.publish(TOPICS.CMD, "GET_HISTORY");
            });

            client.on("message", (topic, payload) => {
                const msg = payload.toString();
                if (topic === TOPICS.STATUS) {
                    pumpState = (msg === "ON");
                    btnPump.innerText = pumpState ? "APAGAR BOMBA" : "ENCENDER BOMBA";
                    btnPump.className = pumpState ? "btn-control off" : "btn-control";
                } 
                else if (topic === TOPICS.DATA) {
                    const data = JSON.parse(msg);
                    addDataToCharts(data.ts, data.temp, data.hum, data.litros);
                } 
                else if (topic === TOPICS.HISTORY) {
                    if (msg !== "EMPTY" && msg !== "CLEARED") parseCSVHistory(msg);
                    if (msg === "CLEARED") { allHistoryData = []; updateCharts(); alert("Historial borrado"); }
                }
            });
        }

        function addDataToCharts(ts, temp, hum, litros) {
            // Actualizar etiquetas
            currTemp.innerText = temp.toFixed(1);
            currHum.innerText = hum.toFixed(1);
            currVol.innerText = litros.toFixed(1);
            
            // Guardar en memoria
            const point = { x: moment(ts), temp, hum, litros };
            allHistoryData.push(point);
            
            // Actualizar gr√°ficas (Solo mantenemos los ultimos 50 puntos para rendimiento visual rapido)
            // Para ver todo el historial, el array allHistoryData se usa al recargar
            updateCharts();
        }

        function parseCSVHistory(csvText) {
            const lines = csvText.split("\n");
            allHistoryData = [];
            lines.forEach(line => {
                const p = line.trim().split(",");
                if (p.length >= 4) { // Aseguramos que tenga al menos 4 columnas
                    allHistoryData.push({ 
                        x: moment(p[0]), 
                        temp: parseFloat(p[1]), 
                        hum: parseFloat(p[2]), 
                        litros: parseFloat(p[3]) 
                    });
                }
            });
            updateCharts();
        }

        function updateCharts() {
            // Clima
            chartClimate.data.datasets[0].data = allHistoryData.map(d => ({x: d.x, y: d.temp}));
            chartClimate.data.datasets[1].data = allHistoryData.map(d => ({x: d.x, y: d.hum}));
            chartClimate.update();

            // Tanque
            chartTank.data.datasets[0].data = allHistoryData.map(d => ({x: d.x, y: d.litros}));
            chartTank.update();
        }

        btnPump.onclick = () => client.publish(TOPICS.CMD, pumpState ? "LED_OFF" : "LED_ON");

        function clearESP32Data() {
            if(confirm("¬øBorrar datos de la SD?")) client.publish(TOPICS.CMD, "CLEAR_DATA");
        }

        function downloadCSV() {
            let csv = "Fecha,Temp,Hum,Litros\n";
            allHistoryData.forEach(d => {
                csv += `${d.x.format("YYYY-MM-DD HH:mm:ss")},${d.temp},${d.hum},${d.litros}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "reporte_tanque.csv";
            a.click();
        }

        connectMQTT();
    </script>
</body>
</html>