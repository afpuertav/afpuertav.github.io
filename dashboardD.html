<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aGROW - Dashboard Definitivo</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        header { background: #1553AD; color: white; padding: 1rem; text-align: center; font-size: 1.8rem; font-weight: bold; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid #1553AD; }
        h2 { color: #1553AD; margin-top: 0; }
        button { padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; margin: 5px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #1553AD; color: white; }
        .btn-primary.off { background: #e74c3c; }
        .btn-warning { background: #f39c12; color: white; }
        .status-badge { padding: 8px 20px; border-radius: 30px; font-weight: bold; display: inline-block; margin: 5px; }
        .badge-on { background: #ffebee; color: #e74c3c; border: 1px solid #e74c3c; }
        .badge-off { background: #e3f2fd; color: #1553AD; border: 1px solid #1553AD; }
        .badge-auto { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .badge-manual { background: #fff3e0; color: #e65100; border: 1px solid #e65100; }
        .mqtt-status { margin-top: 15px; font-size: 0.9rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot.green { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .dot.red { background: #e74c3c; }
        .chart-container { height: 300px; margin-top: 20px; }
        .time-filters { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #1553AD; color: #1553AD; padding: 6px 16px; border-radius: 20px; cursor: pointer; }
        .filter-btn.active { background: #1553AD; color: white; }
        .footer { display: flex; justify-content: space-between; margin-top: 25px; flex-wrap: wrap; gap: 10px; }
        .btn-download { background: #27ae60; color: white; }
        .btn-clear { background: transparent; border: 1px solid #bdc3c7; color: #7f8c8d; }
        .live-value { background: #f8f9fa; padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <header>üì° aGROW - Dashboard Definitivo</header>
    <div class="container">
        <div class="card" style="text-align: center;">
            <h2>Control de Bomba</h2>
            <div>
                <button id="btnPump" class="btn-primary" disabled>CONECTANDO...</button>
                <button id="btnAuto" class="btn-warning" disabled>ü§ñ FORZAR MODO AUTO</button>
            </div>
            <div>
                <span id="pumpStatus" class="status-badge badge-unknown">Bomba: ?</span>
                <span id="modeStatus" class="status-badge badge-unknown">Modo: ?</span>
            </div>
            <div class="mqtt-status">
                <span class="dot" id="connDot"></span>
                <span id="connText">Desconectado</span>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <h2>üå°Ô∏è Clima</h2>
                <div class="live-value">üå°Ô∏è <span id="currTemp">--</span>¬∞C | üíß <span id="currHum">--</span>%</div>
            </div>
            <div class="time-filters">
                <button class="filter-btn" onclick="setTimeRange(1)">1h</button>
                <button class="filter-btn" onclick="setTimeRange(24)">24h</button>
                <button class="filter-btn" onclick="setTimeRange(72)">3d</button>
                <button class="filter-btn active" onclick="setTimeRange('all')">Todo</button>
            </div>
            <div class="chart-container"><canvas id="chartClimate"></canvas></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                <h2>üíß Nivel Tanque</h2>
                <div class="live-value">üì¶ <span id="currVol">--</span> L</div>
            </div>
            <div class="chart-container"><canvas id="chartTank"></canvas></div>
            <div class="footer">
                <button id="downloadBtn" class="btn-download" disabled onclick="downloadCSV()">üì• Descargar CSV</button>
                <button id="clearBtn" class="btn-clear" onclick="clearESP32Data()">üóëÔ∏è Resetear SD</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const MQTT_URL = "wss://d0c74dd51f244a5b87e0373b99197ba7.s1.eu.hivemq.cloud:8884/mqtt";
        const MQTT_OPT = {
            username: "andresPuerta",
            password: "aGROW123",
            reconnectPeriod: 2000,
            clientId: 'web_' + Math.random().toString(16).substr(2, 8),
            keepalive: 60,
            reschedulePings: true
        };
        const TOPICS = {
            DATA: "iot/esp32/data",
            CMD: "iot/esp32/cmd",
            STATUS: "iot/esp32/status",
            HISTORY: "iot/esp32/history"
        };

        // --- Variables de estado ---
        let client = null;
        let pumpState = null;
        let autoMode = true;
        let allHistoryData = [];
        let currentTimeRange = 'all';
        let lastDataTime = 0;
        let connected = false;
        const DATA_TIMEOUT = 30000; // 30 seg

        // --- Elementos DOM ---
        const elements = {
            btnPump: document.getElementById('btnPump'),
            btnAuto: document.getElementById('btnAuto'),
            pumpStatus: document.getElementById('pumpStatus'),
            modeStatus: document.getElementById('modeStatus'),
            connDot: document.getElementById('connDot'),
            connText: document.getElementById('connText'),
            downloadBtn: document.getElementById('downloadBtn'),
            currTemp: document.getElementById('currTemp'),
            currHum: document.getElementById('currHum'),
            currVol: document.getElementById('currVol')
        };

        // --- Gr√°ficas ---
        const chartClimate = new Chart(document.getElementById('chartClimate'), {
            type: 'line',
            data: { datasets: [
                { label: 'Temp (¬∞C)', data: [], borderColor: '#e74c3c', yAxisID: 'y', fill: true },
                { label: 'Humedad (%)', data: [], borderColor: '#3498db', yAxisID: 'y1', fill: true }
            ]},
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'minute' } },
                    y: { type: 'linear', position: 'left', min: 0, max: 50 },
                    y1: { type: 'linear', position: 'right', min: 20, max: 90, grid: { drawOnChartArea: false } }
                }
            }
        });

        const chartTank = new Chart(document.getElementById('chartTank'), {
            type: 'line',
            data: { datasets: [{ label: 'Volumen (L)', data: [], borderColor: '#27ae60', fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time' }, y: { beginAtZero: true } } }
        });

        // --- Funciones de conexi√≥n MQTT ---
        function conectarMQTT() {
            if (client) client.end(true);
            console.log('üì° Conectando MQTT...');
            client = mqtt.connect(MQTT_URL, MQTT_OPT);

            client.on('connect', () => {
                console.log('‚úÖ Conectado al broker');
                connected = true;
                actualizarEstadoConexion();
                client.subscribe([TOPICS.DATA, TOPICS.STATUS, TOPICS.HISTORY], (err) => {
                    if (!err) console.log('üì• Suscrito a t√≥picos');
                });
                setTimeout(() => {
                    if (client && client.connected) {
                        console.log('üì§ Solicitando historial...');
                        client.publish(TOPICS.CMD, 'GET_HISTORY');
                    }
                }, 1000);
            });

            client.on('reconnect', () => {
                console.log('üîÑ Reconnectando...');
                connected = false;
                actualizarEstadoConexion();
            });

            client.on('offline', () => {
                console.log('üîå Offline');
                connected = false;
                actualizarEstadoConexion();
            });

            client.on('error', (err) => {
                console.error('‚ùå Error MQTT:', err);
                connected = false;
                actualizarEstadoConexion();
            });

            client.on('message', (topic, payload) => {
                const msg = payload.toString();
                console.log(`üì® ${topic}: ${msg.substring(0, 50)}...`);
                lastDataTime = Date.now();
                connected = true;
                actualizarEstadoConexion();

                if (topic === TOPICS.STATUS) {
                    pumpState = (msg === 'ON');
                    actualizarUI();
                } else if (topic === TOPICS.DATA) {
                    try {
                        const d = JSON.parse(msg);
                        elements.currTemp.innerText = d.temp.toFixed(1);
                        elements.currHum.innerText = d.hum.toFixed(1);
                        elements.currVol.innerText = d.litros.toFixed(1);
                        pumpState = d.pump;
                        autoMode = (d.mode === 'auto');
                        actualizarUI();
                        allHistoryData.push({ x: moment(d.ts), temp: d.temp, hum: d.hum, litros: d.litros });
                        actualizarGraficas();
                    } catch (e) { console.error('Error parseando DATA', e); }
                } else if (topic === TOPICS.HISTORY) {
                    if (msg === 'EMPTY' || msg === 'CLEARED') {
                        allHistoryData = [];
                        actualizarGraficas();
                    } else {
                        msg.trim().split('\n').forEach(line => {
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                allHistoryData.push({
                                    x: moment(parts[0]),
                                    temp: parseFloat(parts[1]),
                                    hum: parseFloat(parts[2]),
                                    litros: parseFloat(parts[3])
                                });
                            }
                        });
                        actualizarGraficas();
                    }
                }
            });
        }

        function actualizarEstadoConexion() {
            const conectado = connected && client && client.connected;
            elements.connDot.className = 'dot ' + (conectado ? 'green' : 'red');
            elements.connText.innerText = conectado ? 'Conectado' : 'Desconectado';
            elements.downloadBtn.disabled = !conectado;
            const habilitar = conectado && pumpState !== null;
            elements.btnPump.disabled = !habilitar;
            elements.btnAuto.disabled = !conectado;
            console.log('Estado conexi√≥n:', conectado, 'pumpState:', pumpState, 'btnPump disabled:', elements.btnPump.disabled);
        }

        function actualizarUI() {
            if (pumpState === true) {
                elements.pumpStatus.textContent = 'Bomba: ENCENDIDA';
                elements.pumpStatus.className = 'status-badge badge-on';
                elements.btnPump.textContent = 'üî¥ APAGAR BOMBA';
                elements.btnPump.classList.add('off');
            } else if (pumpState === false) {
                elements.pumpStatus.textContent = 'Bomba: APAGADA';
                elements.pumpStatus.className = 'status-badge badge-off';
                elements.btnPump.textContent = 'üü¢ ENCENDER BOMBA';
                elements.btnPump.classList.remove('off');
            } else {
                elements.pumpStatus.textContent = 'Bomba: ?';
                elements.pumpStatus.className = 'status-badge badge-unknown';
                elements.btnPump.textContent = 'CONECTANDO...';
            }
            elements.modeStatus.textContent = autoMode ? 'Modo: Autom√°tico' : 'Modo: Manual';
            elements.modeStatus.className = 'status-badge ' + (autoMode ? 'badge-auto' : 'badge-manual');
            actualizarEstadoConexion();
        }

        function actualizarGraficas() {
            let filtered = allHistoryData;
            if (currentTimeRange !== 'all') {
                const cutoff = moment().subtract(currentTimeRange, 'hours');
                filtered = allHistoryData.filter(d => d.x.isAfter(cutoff));
            }
            chartClimate.data.datasets[0].data = filtered.map(d => ({ x: d.x, y: d.temp }));
            chartClimate.data.datasets[1].data = filtered.map(d => ({ x: d.x, y: d.hum }));
            chartTank.data.datasets[0].data = filtered.map(d => ({ x: d.x, y: d.litros }));
            chartClimate.update('none');
            chartTank.update('none');
        }

        function setTimeRange(hours) {
            currentTimeRange = hours;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            actualizarGraficas();
        }

        // --- Acciones de usuario ---
        elements.btnPump.onclick = () => {
            if (!client || !client.connected || pumpState === null) {
                console.log('No se puede enviar: cliente no conectado o estado desconocido');
                return;
            }
            const cmd = pumpState ? 'PUMP_OFF' : 'PUMP_ON';
            console.log('üì§ Enviando comando:', cmd);
            client.publish(TOPICS.CMD, cmd, {}, (err) => {
                if (err) console.error('Error al publicar:', err);
                else console.log('Comando enviado con √©xito');
            });
            // Feedback visual optimista
            autoMode = false;
            pumpState = !pumpState;
            actualizarUI();
        };

        elements.btnAuto.onclick = () => {
            if (!client || !client.connected) return;
            console.log('üì§ Enviando: AUTO_MODE');
            client.publish(TOPICS.CMD, 'AUTO_MODE');
            autoMode = true;
            actualizarUI();
        };

        function downloadCSV() {
            if (allHistoryData.length === 0) return alert('No hay datos');
            const csv = 'Fecha,Temperatura (¬∞C),Humedad (%),Litros\n' +
                allHistoryData.map(d => `${d.x.format('YYYY-MM-DD HH:mm:ss')},${d.temp.toFixed(2)},${d.hum.toFixed(2)},${d.litros.toFixed(2)}`).join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = `reporte_${moment().format('YYYYMMDD_HHmm')}.csv`;
            a.click();
        }

        function clearESP32Data() {
            if (confirm('‚ö†Ô∏è ¬øBorrar todo el historial de la SD?')) {
                client.publish(TOPICS.CMD, 'CLEAR_DATA');
            }
        }

        // --- Verificar timeout de datos ---
        setInterval(() => {
            if (lastDataTime > 0 && Date.now() - lastDataTime > DATA_TIMEOUT) {
                connected = false;
                actualizarEstadoConexion();
            }
        }, 5000);

        // --- Iniciar ---
        conectarMQTT();
    </script>
</body>
</html>